var l=Object.defineProperty;var d=(o,e,t)=>e in o?l(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var n=(o,e,t)=>d(o,typeof e!="symbol"?e+"":e,t);class p{constructor(){n(this,"cache",{});n(this,"CACHE_EXPIRY",30*60*1e3);n(this,"API_BASE_URL","http://localhost:3000/api");n(this,"defaultSettings",{tribunals:["STF","STJ","TST"],useGoogle:!0,maxResults:10,autoSearch:!0,notifications:!0,cacheEnabled:!0,theme:"auto",language:"pt-BR"});this.init()}init(){console.log("JurisCheck Background Service Worker iniciado"),this.setupEventListeners(),this.setupContextMenus(),this.setupKeyboardShortcuts(),this.loadUserSettings(),setInterval(()=>this.cleanCache(),10*60*1e3)}setupEventListeners(){chrome.runtime.onInstalled.addListener(e=>{this.handleInstallation(e)}),chrome.runtime.onMessage.addListener((e,t,s)=>(this.handleMessage(e,s),!0)),chrome.tabs.onActivated.addListener(e=>{this.handleTabChange(e)}),chrome.tabs.onUpdated.addListener((e,t,s)=>{this.handleTabUpdate(e,t,s)})}handleInstallation(e){e.reason==="install"?(this.showWelcomeNotification(),this.initializeDefaultSettings()):e.reason==="update"&&this.handleUpdate(e.previousVersion)}async handleMessage(e,t){try{switch(e.action){case"searchFromContent":{if("text"in e&&"context"in e){const s=await this.performSearch(e.text,e.options??{}),r={success:!0,results:s.jurisprudencias,searchTime:s.searchTime,totalFound:s.totalFound};t(r)}else t({success:!1,error:"Dados insuficientes para busca"});break}case"searchJurisprudence":{if("text"in e){const r={success:!0,results:await this.searchJurisprudence(e.text,e.options??{})};t(r)}else t({success:!1,error:"Texto não fornecido"});break}case"openPopup":{await this.openPopup(),t({success:!0});break}case"verifyJurisprudence":{if("numero"in e){const s=await this.verifyJurisprudence(e.numero,e.tribunal),r={success:!0,found:s.found,jurisprudencia:s.jurisprudencia,similarResults:s.similarResults};t(r)}else t({success:!1,error:"Número do processo não fornecido"});break}default:{t({success:!1,error:"Ação não reconhecida"});break}}}catch(s){console.error("Erro no background script:",s),t({success:!1,error:"Erro interno"})}}setupContextMenus(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"jurischeck-search",title:'Buscar jurisprudências para "%s"',contexts:["selection"],visible:!0}),chrome.contextMenus.create({id:"search-stf",parentId:"jurischeck-search",title:"Buscar no STF",contexts:["selection"]}),chrome.contextMenus.create({id:"search-stj",parentId:"jurischeck-search",title:"Buscar no STJ",contexts:["selection"]}),chrome.contextMenus.create({id:"search-tst",parentId:"jurischeck-search",title:"Buscar no TST",contexts:["selection"]}),chrome.contextMenus.create({id:"separator1",parentId:"jurischeck-search",type:"separator",contexts:["selection"]}),chrome.contextMenus.create({id:"verify-jurisprudence",parentId:"jurischeck-search",title:"Verificar jurisprudência",contexts:["selection"]})}),chrome.contextMenus.onClicked.addListener((e,t)=>{this.handleContextMenuClick(e,t)})}setupKeyboardShortcuts(){chrome.commands.onCommand.addListener(e=>{this.handleKeyboardShortcut(e)})}async handleKeyboardShortcut(e){const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t!=null&&t.id)switch(e){case"search-selection":{chrome.tabs.sendMessage(t.id,{action:"getSelectedText"},s=>{s!=null&&s.text&&this.performSearch(s.text,{})});break}case"toggle-popup":{await this.openPopup();break}case"quick-search":{chrome.tabs.sendMessage(t.id,{action:"showQuickSearch"});break}}}async handleContextMenuClick(e,t){var r;if(!e.selectionText||!(t!=null&&t.id))return;const s={};switch(e.menuItemId){case"search-stf":{s.tribunals=["STF"];break}case"search-stj":{s.tribunals=["STJ"];break}case"search-tst":{s.tribunals=["TST"];break}case"verify-jurisprudence":{s.verifyMode=!0;break}}await this.performSearch(e.selectionText,s),s.verifyMode?this.showNotification("Verificação","Verificando jurisprudência..."):this.showNotification("Busca",`Buscando em ${((r=s.tribunals)==null?void 0:r.join(", "))??"todos os tribunais"}...`)}async performSearch(e,t={}){const s=this.generateCacheKey(e,t);if(this.isCacheValid(s))return console.log("Retornando resultado do cache"),this.cache[s].results;try{const r=await this.getUserSettings(),a={...r,...t},c=await fetch(`${this.API_BASE_URL}/suggest`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,options:a})});if(!c.ok)throw new Error(`Erro na busca: ${c.status}`);const i=await c.json();return r.cacheEnabled&&this.saveToCache(s,i),await this.saveToHistory(e,i,t),await this.updateStatistics("search",i),i}catch(r){throw console.error("Erro na busca de jurisprudências:",r),this.showNotification("Erro na Busca","Não foi possível buscar jurisprudências. Verifique sua conexão."),r}}async searchJurisprudence(e,t={}){return(await this.performSearch(e,t)).jurisprudencias}async verifyJurisprudence(e,t){try{const s=await fetch(`${this.API_BASE_URL}/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({numero:e,tribunal:t})});if(!s.ok)throw new Error(`Erro na verificação: ${s.status}`);return await s.json()}catch(s){return console.error("Erro na verificação:",s),{success:!1,found:!1,error:s instanceof Error?s.message:"Erro desconhecido"}}}async openPopup(){try{await chrome.action.openPopup()}catch(e){console.warn("Não foi possível abrir popup programaticamente:",e),this.showNotification("JurisCheck","Clique no ícone da extensão para abrir")}}generateCacheKey(e,t){const s=e.replace(/\s+/g,"_"),r=JSON.stringify(t);return`${s}_${r}`}isCacheValid(e){const t=this.cache[e];return t&&Date.now()<t.expiry}saveToCache(e,t){this.cache[e]={results:t,timestamp:Date.now(),expiry:Date.now()+this.CACHE_EXPIRY}}cleanCache(){const e=Date.now();Object.keys(this.cache).forEach(t=>{this.cache[t].expiry<e&&delete this.cache[t]})}async loadUserSettings(){try{(await chrome.storage.sync.get("jurischeck_settings")).jurischeck_settings||await this.initializeDefaultSettings()}catch(e){console.error("Erro ao carregar configurações:",e),await this.initializeDefaultSettings()}}async initializeDefaultSettings(){try{await chrome.storage.sync.set({jurischeck_settings:this.defaultSettings}),console.log("Configurações padrão inicializadas")}catch(e){console.error("Erro ao inicializar configurações:",e)}}async getUserSettings(){try{return(await chrome.storage.sync.get("jurischeck_settings")).jurischeck_settings??this.defaultSettings}catch(e){return console.error("Erro ao obter configurações:",e),this.defaultSettings}}async saveToHistory(e,t,s){var r,a;try{const c={id:Date.now().toString(),query:e,results:((r=t.jurisprudencias)==null?void 0:r.length)??0,timestamp:new Date().toISOString(),url:await this.getCurrentTabUrl(),tribunal:(a=s.tribunals)==null?void 0:a[0]},{jurischeck_history:i=[]}=await chrome.storage.local.get("jurischeck_history"),u=[c,...i.slice(0,99)];await chrome.storage.local.set({jurischeck_history:u})}catch(c){console.error("Erro ao salvar no histórico:",c)}}async updateStatistics(e,t){var s,r;try{const{jurischeck_stats:a={}}=await chrome.storage.local.get("jurischeck_stats"),c=new Date().toISOString().split("T")[0];a[c]||(a[c]={searches:0,results:0,tribunals:{},avgResponseTime:0});const i=a[c];switch(e){case"search":{i.searches++,i.results+=((s=t==null?void 0:t.jurisprudencias)==null?void 0:s.length)??0,t!=null&&t.searchTime&&(i.avgResponseTime=Math.round((i.avgResponseTime*(i.searches-1)+t.searchTime)/i.searches)),(r=t==null?void 0:t.jurisprudencias)==null||r.forEach(u=>{const h=u.tribunal;i.tribunals[h]=(i.tribunals[h]??0)+1});break}}await chrome.storage.local.set({jurischeck_stats:a})}catch(a){console.error("Erro ao atualizar estatísticas:",a)}}async getCurrentTabUrl(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return(e==null?void 0:e.url)??""}catch(e){return console.warn("Erro ao obter URL da aba:",e),""}}handleTabChange(e){console.log("Aba ativa alterada:",e.tabId)}handleTabUpdate(e,t,s){t.status==="complete"&&s.url&&this.detectLegalSite(s)}async detectLegalSite(e){if(!e.url||!e.id)return;if(["stf.jus.br","stj.jus.br","tst.jus.br","jusbrasil.com.br","conjur.com.br"].some(r=>e.url.includes(r))&&(await this.getUserSettings()).autoSearch)try{await chrome.scripting.executeScript({target:{tabId:e.id},func:this.injectLegalSiteEnhancement})}catch(a){console.warn("Erro ao injetar script de melhoria:",a)}}injectLegalSiteEnhancement(){const e=document.body.innerText.match(/\b(RE|REsp|AI|RR|HC|MS)\s+\d+/g);e&&e.length>0&&(console.log("JurisCheck: Jurisprudências detectadas:",e),e.forEach(t=>{console.log("Processo detectado:",t)}))}showWelcomeNotification(){this.showNotification("JurisCheck Instalado!","Bem-vindo! Selecione texto jurídico e clique com o botão direito para buscar jurisprudências.")}handleUpdate(e){const t=chrome.runtime.getManifest().version;console.log(`JurisCheck atualizado de ${e??"desconhecida"} para ${t}`),this.showNotification("JurisCheck Atualizado","Nova versão instalada com melhorias na busca de jurisprudências!"),this.clearCache()}clearCache(){this.cache={},console.log("Cache limpo")}showNotification(e,t){chrome.notifications&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon-48.png",title:e,message:t,silent:!1})}}new p;
